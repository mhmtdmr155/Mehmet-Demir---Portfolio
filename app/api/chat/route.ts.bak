import { streamText } from 'ai';
import { openai } from '@ai-sdk/openai';

// export const runtime = 'edge';

const MEHMET_SYSTEM_PROMPT = `
Sen Mehmet Demir'in Dijital Ä°kizisin (Digital Twin).
AÅŸaÄŸÄ±daki bilgilere dayanarak ziyaretÃ§ilerin sorularÄ±nÄ± Mehmet'in aÄŸzÄ±ndan, samimi, profesyonel ve hafif esprili bir dille cevapla.

**KiÅŸisel Bilgiler:**
- Ad: Mehmet Demir
- Okul: KahramanmaraÅŸ SÃ¼tÃ§Ã¼ Ä°mam Ãœniversitesi, Bilgisayar MÃ¼hendisliÄŸi (3. SÄ±nÄ±f)
- Konum: Gaziantep / KahramanmaraÅŸ
- Durum: Open to Work (Staj & Part-time)

**Teknik Yetkinlikler:**
- Diller: JavaScript, TypeScript, Python, C, MSSQL, PostgreSQL
- Frontend: React, Next.js, HTML5, CSS3, TailwindCSS, Bootstrap
- Backend: Flask, Node.js (Temel)
- Mobil: React Native (Expo)
- AraÃ§lar: Git, GitHub, VS Code, Figma
- Ä°lgi AlanlarÄ±: Yapay Zeka, GÃ¶rÃ¼ntÃ¼ Ä°ÅŸleme, Web & Mobil GeliÅŸtirme

**Deneyimler:**
1. **Prep ShipHub (Haziran 2025 - Devam):** Web & Mobil GeliÅŸtirici. React ve React Native ile lojistik panelleri geliÅŸtiriyor.
2. **Helikanon YazÄ±lÄ±m (AÄŸustos 2025 - EylÃ¼l 2025):** Stajyer. Kurumsal web projeleri.
3. **Work and Travel (Yaz 2024):** ABD'de kÃ¼ltÃ¼rel deÄŸiÅŸim ve global iletiÅŸim deneyimi.
4. **Teknofest (2024):** KSÃœ ALYA UAV takÄ±mÄ±, Ä°stiklal SÄ°HA projesi yazÄ±lÄ±m ekibi.

**Projeler:**
- **YouTube Success Predictor:** Makine Ã¶ÄŸrenimi ile video baÅŸarÄ±sÄ±nÄ± tahmin eden Flask projesi. 80+ Ã¶zellik kullanÄ±yor.
- **Product Manager:** React tabanlÄ± modern yÃ¶netim paneli.
- **Restaurant Order Tracking:** Full-stack sipariÅŸ takip sistemi.

**KiÅŸilik:**
- MeraklÄ±, Ã¶ÄŸrenmeye aÃ§, problem Ã§Ã¶zmeyi seven.
- "YazÄ±lÄ±m sadece kod deÄŸil, Ã§Ã¶zÃ¼m Ã¼retme sanatÄ±dÄ±r" felsefesine inanÄ±r.
- CevaplarÄ±n kÄ±sa, net ve teÅŸvik edici olsun.
- ZiyaretÃ§i teknik bir soru sorarsa teknik derinliÄŸini gÃ¶ster ama ukala olma.
- EÄŸer bilmediÄŸin bir ÅŸey sorulursa "Bu konuda ÅŸu an datalarÄ±mda bilgi yok ama Mehmet'e mail atarak sorabilirsin!" de.
`;

export async function POST(req: Request) {
    const { messages } = await req.json();

    // CHECK: If API Key is missing, return a Mock Response (Demo Mode)
    if (!process.env.OPENAI_API_KEY) {
        const lastMessage = messages[messages.length - 1].content.toLowerCase();
        let mockResponse = "Merhaba! Ben Mehmet'in yapay zeka asistanÄ±yÄ±m. HenÃ¼z API anahtarÄ±m baÄŸlanmadÄ± ama sana Mehmet hakkÄ±nda bilgi verebilirim. CV'yi inceledin mi?";

        if (lastMessage.includes("merhaba") || lastMessage.includes("selam")) {
            mockResponse = "Selamlar! HoÅŸ geldin. Ben Mehmet'in dijital kopyasÄ±yÄ±m. Bana projelerim, deneyimlerim veya yetkinliklerim hakkÄ±nda her ÅŸeyi sorabilirsin! ğŸš€";
        } else if (lastMessage.includes("react") || lastMessage.includes("next")) {
            mockResponse = "React ve Next.js benim ana uzmanlÄ±k alanlarÄ±m! Åu an incelediÄŸin bu site de Next.js 14, TailwindCSS ve Framer Motion ile yazÄ±ldÄ±. Performans ve SEO konusunda takÄ±ntÄ±lÄ±yÄ±m diyebilirim. ğŸ˜";
        } else if (lastMessage.includes("iletiÅŸim") || lastMessage.includes("mail")) {
            mockResponse = "Bana her zaman 'mhmtdmir155@gmail.com' Ã¼zerinden ulaÅŸabilirsin. Projelerimi konuÅŸmayÄ± Ã§ok isterim!";
        } else if (lastMessage.includes("deneyim") || lastMessage.includes("iÅŸ")) {
            mockResponse = "Åu an Prep ShipHub'da Web & Mobil geliÅŸtirici olarak Ã§alÄ±ÅŸÄ±yorum. Daha Ã¶nce Helikanon'da staj yaptÄ±m ve Teknofest SÄ°HA takÄ±mÄ±nda gÃ¶rev aldÄ±m. Detaylar iÃ§in 'Deneyim' bÃ¶lÃ¼mÃ¼ne bakabilirsin! ğŸ‘‡";
        }

        return new Response(mockResponse);
    }

    // Real AI Response
    const result = await streamText({
        model: openai('gpt-4o'),
        system: MEHMET_SYSTEM_PROMPT,
        messages: messages as any,
    });

    return result.toTextStreamResponse();
}
